---
marp: true
theme: default
paginate: true
_paginate: false
header: ''
footer: ''
backgroundColor: white
---

<!-- theme: gaia -->
<!-- _class: lead -->

# 第十二讲 同步与互斥

## 第四节 同步互斥实例问题

---
### 哲学家就餐问题
- 5个哲学家围绕一张圆桌而坐
- 桌子上放着5支叉子
- 每两个哲学家之间放一支
- 哲学家的动作包括思考和进餐
- 进餐时需同时用左右两边的叉子
- 思考时将两支叉子放回原处

如何保证哲学家们的动作有序进行？
如：不出现有人永远拿不到叉子

![bg right:40% 100%](figs/philosopher.png)

---
### 哲学家就餐问题 -- 方案1
![w:900](figs/philo-1.png)

不正确，可能导致死锁

---
### 哲学家就餐问题 -- 方案2
![w:900](figs/philo-2-1.png)

---
### 哲学家就餐问题 -- 方案2
![w:900](figs/philo-2-2.png)

---
### 哲学家就餐问题 -- 方案2
![w:900](figs/philo-2-3.png)

---
### 哲学家就餐问题 -- 方案2
![w:900](figs/philo-2-4.png)


---
### 哲学家就餐问题 -- 方案2
![w:800](figs/philo-2-5.png)
互斥访问正确，但每次只允许一人进餐


---
### 哲学家就餐问题 -- 方案3
![w:800](figs/philo-3-1.png)


---
### 哲学家就餐问题 -- 方案3
![w:800](figs/philo-3-2.png)


---
### 哲学家就餐问题 -- 方案3
![w:800](figs/philo-3-3.png)


---
### 哲学家就餐问题 -- 方案3
![w:800](figs/philo-3-4.png)


---
### 哲学家就餐问题 -- 方案3
![w:800](figs/philo-3-5.png)


---
### 哲学家就餐问题 -- 方案3
![w:750](figs/philo-3-6.png)
没有死锁，可有多人同时就餐

---
### 读者-写者问题
- 共享数据的两类使用者
  - 读者：只读不修改数据
  - 写者：读取和修改数据
- 对共享数据的读写
  - 多个：“读－读”-- 允许
  - 单个：“读－写”-- 互斥
  - 单个：“写－写”-- 互斥

![bg right:50% 100%](figs/reader-writer.png)

---
### 读者-写者问题
- 读者优先策略
   - 只要有读者正在读状态，后来的读者都能直接进入
   - 如读者持续不断进入，则写者就处于饥饿
 - 写者优先策略
   - 只要有写者就绪，写者应尽快执行写操作
   - 如写者持续不断就绪，则读者就处于饥饿

![bg right:40% 100%](figs/reader-writer.png)

---
### 读者-写者问题 -- 方案1
用信号量描述每个约束
- 信号量WriteMutex：控制读写操作的互斥，初始化为1
- 读者计数Rcount ：正在进行读操作的读者数目，初始化为0
- 信号量CountMutex：控制对读者计数的互斥修改，初始化为1
![bg right:40% 100%](figs/reader-writer.png)

---
### 读者-写者问题 -- 方案1(信号量)
![w:800](figs/wr-1.png)

---
### 读者-写者问题 -- 方案1(信号量)
![w:800](figs/wr-2.png)

---
### 读者-写者问题 -- 方案1(信号量)
![w:800](figs/wr-3.png)

---
### 读者-写者问题 -- 方案1(信号量)
![w:800](figs/wr-4.png)

---
### 读者-写者问题 -- 方案1(信号量)
![w:800](figs/wr-5.png)

---
### 读者-写者问题 -- 方案1(信号量)
![w:700](figs/wr-6.png)
此实现中，读者优先


---
### 读者-写者问题 -- 方案2(管程)
![w:900](figs/mwr-1.png)


---
### 读者-写者问题 -- 方案2(管程)
![w:900](figs/mwr-2.png)



---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-3.png)


---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-4.png)



---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-5.png)


---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-6.png)


---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-7.png)



---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-8.png)


---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-9.png)



---
### 读者-写者问题 -- 方案2(管程) --读者
![w:900](figs/mwr-10.png)


---
### 读者-写者问题 -- 方案2(管程) --写者
![w:900](figs/mwr-11.png)



---
### 读者-写者问题 -- 方案2(管程) --写者
![w:900](figs/mwr-12.png)



---
### 读者-写者问题 -- 方案2(管程) --写者
![w:900](figs/mwr-13.png)


---
### 读者-写者问题 -- 方案2(管程) --写者
![w:900](figs/mwr-14.png)



---
### 读者-写者问题 -- 方案2(管程) --写者
![w:900](figs/mwr-15.png)



---
### 读者-写者问题 -- 方案2(管程) --写者
![w:900](figs/mwr-16.png)